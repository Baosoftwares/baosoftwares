<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerador de Chave de Acesso - BaohFood Checkout</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI Variable',Segoe UI,Tahoma,Verdana,sans-serif;}
    body{height:100vh;display:flex;align-items:center;justify-content:center;
      background:radial-gradient(circle at top left,#1e3a8a,#0f172a 80%);
      color:#f1f5f9;overflow:hidden;}
    .background-blur{position:absolute;width:250%;height:250%;
      background:conic-gradient(from 180deg,#60a5fa,#1e3a8a,#1e293b,#60a5fa);
      filter:blur(160px);opacity:0.3;animation:rotate 15s linear infinite;z-index:0;}
    @keyframes rotate{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
    .container{position:relative;width:420px;padding:40px 30px;border-radius:20px;
      background:rgba(30,41,59,0.85);box-shadow:0 8px 32px rgba(0,0,0,0.6);
      text-align:center;border:1px solid rgba(255,255,255,0.1);z-index:1;}
    h1{color:#60a5fa;font-weight:600;font-size:1.6rem;margin-bottom:25px;text-shadow:0 0 10px rgba(96,165,250,0.6);}
    input{width:100%;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);
      background:rgba(255,255,255,0.08);color:#f1f5f9;font-size:15px;text-align:center;outline:none;margin-bottom:15px;}
    button{padding:12px 26px;font-size:16px;font-weight:600;border:none;border-radius:10px;cursor:pointer;transition:all 0.3s ease;margin-top:12px;}
    .generate-btn{background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white;box-shadow:0 0 18px rgba(37,99,235,0.4);}
    .generate-btn:hover{background:linear-gradient(135deg,#60a5fa,#2563eb);}
    .copy-btn{background:linear-gradient(135deg,#22c55e,#15803d);color:#f8fafc;}
    .copy-btn:hover{background:linear-gradient(135deg,#4ade80,#16a34a);}
    .chave-container{margin-top:25px;}
    #chave,#validade{background:rgba(255,255,255,0.06);padding:14px;border-radius:8px;margin-bottom:10px;font-weight:600;}
    #mensagem{display:none;margin-top:10px;font-weight:500;text-align:center;}
    .sucesso{color:#4ade80;} .erro{color:#f87171;}
  </style>
</head>
<body>
  <div class="background-blur"></div>

  <div class="container">
    <h1>üîê Gerador de Chave de Acesso</h1>

    <input type="text" id="cpfCnpj" placeholder="Digite seu CPF ou CNPJ"
      maxlength="18" oninput="this.value=this.value.replace(/[^0-9]/g,'')">

    <p id="mensagem"></p>

    <button id="btnGerar" class="generate-btn" onclick="gerarChave()">Gerar Chave de Acesso</button>

    <div id="chaveContainer" class="chave-container">
      <p id="chave"></p>
      <p id="validade"></p>
      <button onclick="copiarChave()" id="copyBtn" class="copy-btn" style="display:none;">üìã Copiar</button>
    </div>
  </div>

  <script>
async function gerarChave() {
  const cpfCnpj = document.getElementById('cpfCnpj').value.trim();
  const msgEl = document.getElementById('mensagem');
  const btn = document.getElementById('btnGerar');
  msgEl.style.display = 'none';

  if (!cpfCnpj) {
    mostrarMensagem('‚ö†Ô∏è Insira o CPF ou CNPJ antes de gerar a chave.', 'erro');
    return;
  }

  const somenteNumeros = cpfCnpj.replace(/\D/g, '');

  // üö´ Verifica validade matem√°tica
  if (!validarCpfCnpj(somenteNumeros)) {
    mostrarMensagem('‚ùå CPF ou CNPJ inv√°lido. Verifique os n√∫meros informados.', 'erro');
    return;
  }

  btn.disabled = true;
  btn.innerText = "Verificando...";

  // ‚úÖ Se for CNPJ, consulta API p√∫blica
  if (somenteNumeros.length === 14) {
    try {
      const response = await fetch(`https://publica.cnpj.ws/cnpj/${somenteNumeros}`);
      if (!response.ok) throw new Error("CNPJ n√£o encontrado");
      const data = await response.json();

      if (!data.razao_social) {
        mostrarMensagem("‚ùå CNPJ inv√°lido ou inexistente na Receita Federal.", "erro");
        btn.disabled = false;
        btn.innerText = "Gerar Chave de Acesso";
        return;
      }
    } catch (error) {
      mostrarMensagem("‚ùå CNPJ inexistente ou erro ao consultar API oficial.", "erro");
      btn.disabled = false;
      btn.innerText = "Gerar Chave de Acesso";
      return;
    }
  }

  try {
    // üî• Verifica duplicidade no Firebase
    const ref = database.ref("chave_acesso");
    const snapshot = await ref.once("value");

    let cpfJaExiste = false;
    if (snapshot.exists()) {
      snapshot.forEach(child => {
        const data = child.val();
        if (data.cpf_cnpj === somenteNumeros) cpfJaExiste = true;
      });
    }

    if (cpfJaExiste) {
      mostrarMensagem("‚ö†Ô∏è CPF ou CNPJ j√° cadastrado. Voc√™ n√£o pode gerar uma nova chave.", "erro");
      btn.disabled = false;
      btn.innerText = "Gerar Chave de Acesso";
      return;
    }

    // ‚úÖ Gera chave aleat√≥ria
    const caracteres = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
    let chave = "";
    for (let i = 0; i < 16; i++) {
      chave += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
    }

    const hoje = new Date();
    const validade = new Date(hoje);
    validade.setFullYear(validade.getFullYear() + 1);
    const validadeFormatada = validade.toLocaleDateString("pt-BR");

    await database.ref("chave_acesso").push({
      chave: chave,
      cpf_cnpj: somenteNumeros,
      validade: validadeFormatada,
      dataCadastro: new Date().toLocaleString("pt-BR")
    });

    document.getElementById("chave").innerText = chave;
    document.getElementById("validade").innerText = "üìÖ V√°lida at√©: " + validadeFormatada;
    document.getElementById("copyBtn").style.display = "inline-block";
    mostrarMensagem("‚úÖ Chave gerada e salva com sucesso!", "sucesso");

  } catch (error) {
    console.error(error);
    mostrarMensagem("‚ùå Erro ao salvar no Firebase.", "erro");
  }

  btn.disabled = false;
  btn.innerText = "Gerar Chave de Acesso";
}
</script>
</body>
</html>
