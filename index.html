<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gerador de Chave de Acesso - BaohFood Checkout</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI Variable',Segoe UI,Tahoma,Verdana,sans-serif;}
    body{height:100vh;display:flex;align-items:center;justify-content:center;
      background:radial-gradient(circle at top left,#1e3a8a,#0f172a 80%);
      color:#f1f5f9;overflow:hidden;}
    .background-blur{position:absolute;width:250%;height:250%;
      background:conic-gradient(from 180deg,#60a5fa,#1e3a8a,#1e293b,#60a5fa);
      filter:blur(160px);opacity:0.3;animation:rotate 15s linear infinite;z-index:0;}
    @keyframes rotate{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
    .container{position:relative;width:420px;padding:40px 30px;border-radius:20px;
      background:rgba(30,41,59,0.85);box-shadow:0 8px 32px rgba(0,0,0,0.6);
      text-align:center;border:1px solid rgba(255,255,255,0.1);z-index:1;}
    h1{color:#60a5fa;font-weight:600;font-size:1.6rem;margin-bottom:25px;text-shadow:0 0 10px rgba(96,165,250,0.6);}
    input{width:100%;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);
      background:rgba(255,255,255,0.08);color:#f1f5f9;font-size:15px;text-align:center;outline:none;margin-bottom:15px;}
    button{padding:12px 26px;font-size:16px;font-weight:600;border:none;border-radius:10px;cursor:pointer;transition:all 0.3s ease;margin-top:12px;}
    .generate-btn{background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white;box-shadow:0 0 18px rgba(37,99,235,0.4);}
    .generate-btn:hover{background:linear-gradient(135deg,#60a5fa,#2563eb);}
    .copy-btn{background:linear-gradient(135deg,#22c55e,#15803d);color:#f8fafc;}
    .copy-btn:hover{background:linear-gradient(135deg,#4ade80,#16a34a);}
    .chave-container{margin-top:25px;}
    #chave,#validade{background:rgba(255,255,255,0.06);padding:14px;border-radius:8px;margin-bottom:10px;font-weight:600;}
    #mensagem{display:none;margin-top:10px;font-weight:500;text-align:center;}
    .sucesso{color:#4ade80;} .erro{color:#f87171;}
  </style>
</head>
<body>
  <div class="background-blur"></div>

  <div class="container">
    <h1>üîê Gerador de Chave de Acesso</h1>

    <input type="text" id="cpfCnpj" placeholder="Digite seu CPF ou CNPJ"
      maxlength="18" oninput="this.value=this.value.replace(/[^0-9]/g,'')">

    <p id="mensagem"></p>

    <button id="btnGerar" class="generate-btn" onclick="gerarChave()">Gerar Chave de Acesso</button>

    <div id="chaveContainer" class="chave-container">
      <p id="chave"></p>
      <p id="validade"></p>
      <button onclick="copiarChave()" id="copyBtn" class="copy-btn" style="display:none;">üìã Copiar</button>
    </div>
  </div>

 <script type="module">
  // Fun√ß√£o para validar formato do CNPJ
  function validarCNPJ(cnpj) {
    cnpj = cnpj.replace(/[^\d]+/g, '');
    if (cnpj.length !== 14) return false;

    // Elimina CNPJs inv√°lidos conhecidos
    if (/^(\d)\1+$/.test(cnpj)) return false;

    let tamanho = cnpj.length - 2;
    let numeros = cnpj.substring(0, tamanho);
    let digitos = cnpj.substring(tamanho);
    let soma = 0;
    let pos = tamanho - 7;

    for (let i = tamanho; i >= 1; i--) {
      soma += numeros.charAt(tamanho - i) * pos--;
      if (pos < 2) pos = 9;
    }

    let resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
    if (resultado != digitos.charAt(0)) return false;

    tamanho = tamanho + 1;
    numeros = cnpj.substring(0, tamanho);
    soma = 0;
    pos = tamanho - 7;

    for (let i = tamanho; i >= 1; i--) {
      soma += numeros.charAt(tamanho - i) * pos--;
      if (pos < 2) pos = 9;
    }

    resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
    if (resultado != digitos.charAt(1)) return false;

    return true;
  }

  // Fun√ß√£o para consultar a API p√∫blica da Receita Federal
  async function consultarCNPJReceita(cnpj) {
    try {
      const cnpjLimpo = cnpj.replace(/\D/g, '');
      const resposta = await fetch(`https://publica.cnpj.ws/cnpj/${cnpjLimpo}`);
      
      if (!resposta.ok) {
        throw new Error('CNPJ n√£o encontrado ou inv√°lido.');
      }

      const dados = await resposta.json();
      if (dados && dados.razao_social) {
        return {
          valido: true,
          razao_social: dados.razao_social,
          nome_fantasia: dados.estabelecimento?.nome_fantasia || '',
          situacao: dados.estabelecimento?.situacao_cadastral || 'DESCONHECIDA',
        };
      } else {
        return { valido: false };
      }
    } catch (erro) {
      console.error('Erro ao consultar CNPJ:', erro);
      return { valido: false };
    }
  }

  // Fun√ß√£o principal (executa antes de gerar chave)
  async function validarCNPJAntesGerar() {
    const inputCNPJ = document.getElementById('cnpj');
    const cnpj = inputCNPJ.value.trim();

    if (!validarCNPJ(cnpj)) {
      alert('‚ùå CNPJ inv√°lido! Verifique o n√∫mero digitado.');
      return false;
    }

    // Consulta a base da Receita Federal
    const resultado = await consultarCNPJReceita(cnpj);
    if (!resultado.valido) {
      alert('‚ö†Ô∏è CNPJ n√£o encontrado na base da Receita Federal. Digite um CNPJ v√°lido.');
      return false;
    }

    if (resultado.situacao !== 'ATIVA') {
      alert(`‚ö†Ô∏è Este CNPJ est√° com situa√ß√£o cadastral: ${resultado.situacao}`);
      return false;
    }

    alert(`‚úÖ CNPJ v√°lido!\nRaz√£o Social: ${resultado.razao_social}`);
    return true;
  }

  // Exemplo de uso no bot√£o de gerar chave
  document.getElementById('gerarChaveBtn').addEventListener('click', async () => {
    const valido = await validarCNPJAntesGerar();
    if (valido) {
      gerarChaveAcesso(); // substitua pela sua fun√ß√£o que cria a chave
    }
  });
</script>
</body>
</html>
