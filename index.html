<!DOCTYPE html>
<html lang="pt-br">
<head>
Â  <meta charset="UTF-8">
Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  <title>Gerador de Chave de Acesso - BaohFood Checkout</title>

Â  Â  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

Â  <style>
Â  Â  *{margin:0;padding:0;box-sizing:border-box;font-family:'Segoe UI Variable',Segoe UI,Tahoma,Verdana,sans-serif;}
Â  Â  body{height:100vh;display:flex;align-items:center;justify-content:center;
Â  Â  Â  background:radial-gradient(circle at top left,#1e3a8a,#0f172a 80%);
Â  Â  Â  color:#f1f5f9;overflow:hidden;}
Â  Â  .background-blur{position:absolute;width:250%;height:250%;
Â  Â  Â  background:conic-gradient(from 180deg,#60a5fa,#1e3a8a,#1e293b,#60a5fa);
Â  Â  Â  filter:blur(160px);opacity:0.3;animation:rotate 15s linear infinite;z-index:0;}
Â  Â  @keyframes rotate{0%{transform:rotate(0deg);}100%{transform:rotate(360deg);}}
Â  Â  .container{position:relative;width:420px;padding:40px 30px;border-radius:20px;
Â  Â  Â  background:rgba(30,41,59,0.85);box-shadow:0 8px 32px rgba(0,0,0,0.6);
Â  Â  Â  text-align:center;border:1px solid rgba(255,255,255,0.1);z-index:1;}
Â  Â  h1{color:#60a5fa;font-weight:600;font-size:1.6rem;margin-bottom:25px;text-shadow:0 0 10px rgba(96,165,250,0.6);}
Â  Â  input{width:100%;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.2);
Â  Â  Â  background:rgba(255,255,255,0.08);color:#f1f5f9;font-size:15px;text-align:center;outline:none;margin-bottom:15px;}
Â  Â  button{padding:12px 26px;font-size:16px;font-weight:600;border:none;border-radius:10px;cursor:pointer;transition:all 0.3s ease;margin-top:12px;}
Â  Â  .generate-btn{background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:white;box-shadow:0 0 18px rgba(37,99,235,0.4);}
Â  Â  .generate-btn:hover{background:linear-gradient(135deg,#60a5fa,#2563eb);}
Â  Â  .copy-btn{background:linear-gradient(135deg,#22c55e,#15803d);color:#f8fafc;}
Â  Â  .copy-btn:hover{background:linear-gradient(135deg,#4ade80,#16a34a);}
Â  Â  .chave-container{margin-top:25px;}
Â  Â  #chave,#validade{background:rgba(255,255,255,0.06);padding:14px;border-radius:8px;margin-bottom:10px;font-weight:600;}
Â  Â  #mensagem{display:none;margin-top:10px;font-weight:500;text-align:center;}
Â  Â  .sucesso{color:#4ade80;} .erro{color:#f87171;}
Â  </style>
</head>
<body>
Â  <div class="background-blur"></div>

Â  <div class="container">
Â  Â  <h1>ğŸ” Gerador de Chave de Acesso</h1>

Â  Â  <input type="text" id="cpfCnpj" placeholder="Digite seu CPF ou CNPJ"
Â  Â  Â  maxlength="18" oninput="this.value=this.value.replace(/[^0-9]/g,'')">

Â  Â  <p id="mensagem"></p>

Â  Â  <button id="btnGerar" class="generate-btn" onclick="gerarChave()">Gerar Chave de Acesso</button>

Â  Â  <div id="chaveContainer" class="chave-container">
Â  Â  Â  <p id="chave"></p>
Â  Â  Â  <p id="validade"></p>
Â  Â  Â  <button onclick="copiarChave()" id="copyBtn" class="copy-btn" style="display:none;">ğŸ“‹ Copiar</button>
Â  Â  </div>
Â  </div>

Â  <script>

// --- PASSO 1: CONFIGURAÃ‡ÃƒO E INICIALIZAÃ‡ÃƒO DO FIREBASE ---
// SUBSTITUA OS VALORES ABAIXO PELAS SUAS CREDENCIAIS REAIS DO FIREBASE
const firebaseConfig = {
    apiKey: "AIzaSyAbVghjW4P8Dt8DngDtdmYDeU4680PXf_4",
    authDomain: "integra-8eaac.firebaseapp.com",
    databaseURL: "https://integra-8eaac-default-rtdb.firebaseio.com",
    projectId: "integra-8eaac",
    storageBucket: "integra-8eaac.appspot.com",
    messagingSenderId: "613297970798",
    appId: "1:613297970798:android:116edc2a1c7d9b1ac7107f"
  };

// Inicializa o Firebase
firebase.initializeApp(firebaseConfig);

// ObtÃ©m a referÃªncia ao serviÃ§o de banco de dados
const database = firebase.database();


// --- FUNÃ‡Ã•ES AUXILIARES FALTANTES ---

/**
 * Exibe uma mensagem de status na tela.
 * @param {string} texto - A mensagem a ser exibida.
 * @param {string} tipo - O tipo da mensagem ('sucesso' ou 'erro').
 */
function mostrarMensagem(texto, tipo) {
Â  const msgEl = document.getElementById('mensagem');
Â  msgEl.innerText = texto;
Â  msgEl.className = tipo; 
Â  msgEl.style.display = 'block';
}

/**
 * Copia o conteÃºdo da chave de acesso para a Ã¡rea de transferÃªncia.
 */
function copiarChave() {
Â  const chave = document.getElementById("chave").innerText;
Â  if (chave) {
Â  Â  navigator.clipboard.writeText(chave).then(() => {
Â  Â  Â  mostrarMensagem("âœ… Chave copiada para a Ã¡rea de transferÃªncia!", "sucesso");
Â  Â  }).catch(err => {
Â  Â  Â  console.error('Erro ao copiar: ', err);
Â  Â  Â  mostrarMensagem("âŒ Falha ao copiar a chave.", "erro");
Â  Â  });
Â  }
}

/**
 * FUNÃ‡ÃƒO ESSENCIAL FALTANTE: Valida matematicamente CPF ou CNPJ.
 * @param {string} doc - CPF (11 dÃ­gitos) ou CNPJ (14 dÃ­gitos)
 * @returns {boolean} - True se o documento for vÃ¡lido, False caso contrÃ¡rio.
 */
function validarCpfCnpj(doc) {
  doc = doc.replace(/[^\d]/g, '');

  if (doc.length === 11) {
    // ValidaÃ§Ã£o de CPF
    if (doc.split('').every(c => c === doc[0])) return false;
    let soma = 0;
    let resto;
    for (let i = 1; i <= 9; i++) soma += parseInt(doc.substring(i - 1, i)) * (11 - i);
    resto = (soma * 10) % 11;
    if ((resto === 10) || (resto === 11)) resto = 0;
    if (resto !== parseInt(doc.substring(9, 10))) return false;
    soma = 0;
    for (let i = 1; i <= 10; i++) soma += parseInt(doc.substring(i - 1, i)) * (12 - i);
    resto = (soma * 10) % 11;
    if ((resto === 10) || (resto === 11)) resto = 0;
    if (resto !== parseInt(doc.substring(10, 11))) return false;
    return true;
  } else if (doc.length === 14) {
    // ValidaÃ§Ã£o de CNPJ
    if (doc.split('').every(c => c === doc[0])) return false;
    let tamanho = doc.length - 2;
    let numeros = doc.substring(0, tamanho);
    let digitos = doc.substring(tamanho);
    let soma = 0;
    let pos = tamanho - 7;
    for (let i = tamanho; i >= 1; i--) {
      soma += numeros.charAt(tamanho - i) * pos--;
      if (pos < 2) pos = 9;
    }
    let resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
    if (resultado !== parseInt(digitos.charAt(0))) return false;
    tamanho = tamanho + 1;
    numeros = doc.substring(0, tamanho);
    soma = 0;
    pos = tamanho - 7;
    for (let i = tamanho; i >= 1; i--) {
      soma += numeros.charAt(tamanho - i) * pos--;
      if (pos < 2) pos = 9;
    }
    resultado = soma % 11 < 2 ? 0 : 11 - soma % 11;
    if (resultado !== parseInt(digitos.charAt(1))) return false;
    return true;
  }
  return false; // NÃ£o Ã© 11 nem 14 dÃ­gitos
}

// --- FUNÃ‡ÃƒO PRINCIPAL CORRIGIDA ---
async function gerarChave() {
Â  const cpfCnpj = document.getElementById('cpfCnpj').value.trim();
Â  const msgEl = document.getElementById('mensagem');
Â  const btn = document.getElementById('btnGerar');
Â  msgEl.style.display = 'none';

Â  // 1. VerificaÃ§Ã£o inicial
Â  if (!cpfCnpj) {
Â  Â  mostrarMensagem('âš ï¸ Insira o CPF ou CNPJ antes de gerar a chave.', 'erro');
Â  Â  return;
Â  }

Â  const somenteNumeros = cpfCnpj.replace(/\D/g, '');

Â  // 2. VerificaÃ§Ã£o de validade matemÃ¡tica (AGORA FUNCIONA)
Â  if (!validarCpfCnpj(somenteNumeros)) {
Â  Â  mostrarMensagem('âŒ CPF ou CNPJ invÃ¡lido. Verifique os nÃºmeros informados.', 'erro');
Â  Â  return;
Â  }

Â  btn.disabled = true;
Â  btn.innerText = "Verificando...";

Â  // 3. Se for CNPJ, consulta API pÃºblica
Â  if (somenteNumeros.length === 14) {
Â  Â  try {
Â  Â  Â  const response = await fetch(`https://publica.cnpj.ws/cnpj/${somenteNumeros}`);
Â  Â  Â  if (!response.ok) throw new Error("CNPJ nÃ£o encontrado");
Â  Â  Â  const data = await response.json();

Â  Â  Â  if (!data.razao_social) {
Â  Â  Â  Â  mostrarMensagem("âŒ CNPJ invÃ¡lido ou inexistente na Receita Federal.", "erro");
Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  btn.innerText = "Gerar Chave de Acesso";
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  } catch (error) {
Â  Â  Â  // Captura o erro da API (Ex: 404 Not Found)
Â  Â  Â  mostrarMensagem("âŒ CNPJ inexistente ou erro ao consultar API oficial.", "erro");
Â  Â  Â  btn.disabled = false;
Â  Â  Â  btn.innerText = "Gerar Chave de Acesso";
Â  Â  Â  return;
Â  Â  }
Â  }

Â  try {
Â  Â  // 4. Verifica duplicidade no Firebase (AGORA USA A VARIÃVEL 'database')
Â  Â  const ref = database.ref("chave_acesso");
Â  Â  const snapshot = await ref.once("value");

Â  Â  let cpfJaExiste = false;
Â  Â  if (snapshot.exists()) {
Â  Â  Â  snapshot.forEach(child => {
Â  Â  Â  Â  const data = child.val();
Â  Â  Â  Â  if (data.cpf_cnpj === somenteNumeros) cpfJaExiste = true;
Â  Â  Â  });
Â  Â  }

Â  Â  if (cpfJaExiste) {
Â  Â  Â  mostrarMensagem("âš ï¸ CPF ou CNPJ jÃ¡ cadastrado. VocÃª nÃ£o pode gerar uma nova chave.", "erro");
Â  Â  Â  btn.disabled = false;
Â  Â  Â  btn.innerText = "Gerar Chave de Acesso";
Â  Â  Â  return;
Â  Â  }

Â  Â  // 5. Gera e salva a chave
Â  Â  const caracteres = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
Â  Â  let chave = "";
Â  Â  for (let i = 0; i < 16; i++) {
Â  Â  Â  chave += caracteres.charAt(Math.floor(Math.random() * caracteres.length));
Â  Â  }

Â  Â  const hoje = new Date();
Â  Â  const validade = new Date(hoje);
Â  Â  validade.setFullYear(validade.getFullYear() + 1);
Â  Â  const validadeFormatada = validade.toLocaleDateString("pt-BR");

Â  Â  await database.ref("chave_acesso").push({
Â  Â  Â  chave: chave,
Â  Â  Â  cpf_cnpj: somenteNumeros,
Â  Â  Â  validade: validadeFormatada,
Â  Â  Â  dataCadastro: new Date().toLocaleString("pt-BR")
Â  Â  });

Â  Â  document.getElementById("chave").innerText = chave;
Â  Â  document.getElementById("validade").innerText = "ğŸ“… VÃ¡lida atÃ©: " + validadeFormatada;
Â  Â  document.getElementById("copyBtn").style.display = "inline-block";
Â  Â  mostrarMensagem("âœ… Chave gerada e salva com sucesso!", "sucesso");

Â  } catch (error) {
Â  Â  console.error("Erro no Firebase ou lÃ³gica:", error);
Â  Â  mostrarMensagem("âŒ Erro no sistema (Firebase nÃ£o configurado ou erro de rede).", "erro");
Â  }

Â  btn.disabled = false;
Â  btn.innerText = "Gerar Chave de Acesso";
}
</script>
</body>
</html>
